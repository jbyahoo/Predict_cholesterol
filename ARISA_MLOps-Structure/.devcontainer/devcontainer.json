{
	"name": "ARISA-MLOps-devcontainer",
	"image": "mcr.microsoft.com/devcontainers/python:3.11-bullseye",

	"postCreateCommand": "pip install --no-cache-dir mlflow==2.12.1 azure-storage-blob pymssql && pip install -r requirements.txt",
	"postStartCommand": "mlflow ui --backend-store-uri 'mssql+pymssql://${MLFLOWDBUSERNAME}:${MLFLOWDBPASS}@${MLFLOWDBENDPOINT}:${MLFLOWDBPORT}/${MLFLOWDB}' --default-artifact-root wasbs://${ARTIFACT_CONTAINER}@${ARTIFACT_STORAGE_ACCOUNT}.blob.core.windows.net/models --host 0.0.0.0 --port 5000",
	
	"forwardPorts": [5000, 8080],

	"customizations": {
		"vscode": {
			"extensions": [
				"humao.rest-client",
                "ms-dotnettools.dotnet-interactive-vscode",
				"ms-azuretools.vscode-docker",
				"ms-python.python",
				"github.copilot",
				"github.copilot-chat"
			]
		}
	},
	
	"remoteEnv": {
		"MLFLOWDBUSERNAME": "${localEnv:MLFLOWDBUSERNAME}",
		"MLFLOWDBPASS": "${localEnv:MLFLOWDBPASS}",
		"MLFLOWDBENDPOINT": "${localEnv:MLFLOWDBENDPOINT}",
		"MLFLOWDBPORT": "${localEnv:MLFLOWDBPORT}",
		"MLFLOWDB": "${localEnv:MLFLOWDB}",
		"ARTIFACT_CONTAINER": "${localEnv:ARTIFACT_CONTAINER}",
		"ARTIFACT_STORAGE_ACCOUNT": "${localEnv:ARTIFACT_STORAGE_ACCOUNT}",
		"AZURE_STORAGE_CONNECTION_STRING": "${localEnv:AZURE_STORAGE_CONNECTION_STRING}"
	},
	
	"containerEnv": {
		"iscontainer": "y",
        "MLFLOW_TRACKING_URI": "http://localhost:5000"
	},
	
	"portsAttributes": {
		"5000": {
			"label": "MLflow UI",
			"onAutoForward": "openBrowser"
		}
	},

	"secrets": {
		"MLFLOWDBUSERNAME": {
			"description": "Username for authenticating the Mlflow backend db connection."
		},
		"MLFLOWDBPASS": { 
			"description": "Password for authenticating the Mlflow backend db connection."
		},
		"MLFLOWDBENDPOINT": { 
			"description": "Endpoint where the Mlflow backend is publicly available."
		},
		"MLFLOWDBPORT": { 
			"description": "Port where the Mlflow backend db is exposed."
		},
		"MLFLOWDB": { 
			"description": "Name of Mlflow backend db."
		},
		"ARTIFACT_CONTAINER": {
			"description": "Azure Blob Storage container for MLflow artifacts."
		},
		"ARTIFACT_STORAGE_ACCOUNT": {
			"description": "Azure Storage Account for MLflow artifacts."
		},
		"AZURE_STORAGE_CONNECTION_STRING": {
			"description": "Azure Storage connection string for MLflow artifact upload."
		}
	}
}
